<<<<<<< HEAD
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
=======
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
>>>>>>> 0989372 (add fitur inventory dan history)
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:ganteng@localhost:5432/project-paramata?schema=public"
}

<<<<<<< HEAD
enum Role {
  ADMIN
  USER
  MANAGER
}

enum ItemStatus {
  AVAILABLE
  IN_CALIBRATION
  RENTED
  IN_MAINTENANCE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  RENTAL_REQUEST
  RENTAL_STATUS_CHANGE
  CALIBRATION_REMINDER
  CALIBRATION_STATUS_CHANGE
  RENTAL_DUE_REMINDER
  MAINTENANCE_REMINDER
  INVENTORY_SCHEDULE
  VENDOR_INFO
  GENERAL_INFO
}

enum ActivityType {
  ITEM_CREATED
  ITEM_UPDATED
  ITEM_DELETED
  CALIBRATION_CREATED
  CALIBRATION_UPDATED
  CALIBRATION_DELETED
  MAINTENANCE_CREATED
  MAINTENANCE_UPDATED
  MAINTENANCE_DELETED
  RENTAL_CREATED
  RENTAL_UPDATED
  RENTAL_DELETED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  VENDOR_CREATED
  VENDOR_UPDATED
  VENDOR_DELETED
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rentals               Rental[]
  calibrations          Calibration[]
  maintenances          Maintenance[]
  activities            ActivityLog[]
  inventoryChecks       InventoryCheck[]
  calibrationStatusLogs CalibrationStatusLog[]
  maintenanceStatusLogs MaintenanceStatusLog[]
  rentalStatusLogs      RentalStatusLog[]
  notifications         Notification[]
  notificationPreference NotificationPreference?
  pushSubscriptions     PushSubscription[]
  affectedUserLogs      ActivityLog[]    @relation("AffectedUserLogs")
}

model Item {
  serialNumber    String         @id
  name            String
  partNumber      String
  sensor          String?
  description     String?
  customer        Vendor?        @relation("CustomerItems", fields: [customerId], references: [id])
  customerId      String?
  status          ItemStatus     @default(AVAILABLE)
  lastVerifiedAt  DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  rentals           Rental[]
  calibrations      Calibration[]
  maintenances      Maintenance[]
  histories         ItemHistory[]
  inventoryCheckItems InventoryCheckItem[]
  activityLogs      ActivityLog[]
}

model Rental {
  id           String        @id @default(uuid())
  item         Item          @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial   String
  user         User          @relation(fields: [userId], references: [id])
  userId       String
  poNumber     String?       // Purchase Order Number (opsional)
  doNumber     String?       // Delivery Order Number (opsional)
  status       RequestStatus @default(PENDING)
  startDate    DateTime
  endDate      DateTime?
  returnDate   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Rental details
  renterName     String?     // Name of the person renting the item
  renterPhone    String?     // Phone number of the renter
  renterAddress  String?     // Address of the renter
  initialCondition String?   // Initial condition of the item when rented
  returnCondition String?    // Condition of the item when returned
  
  statusLogs   RentalStatusLog[]
  activityLogs ActivityLog[]
}

model Calibration {
  id              String        @id @default(uuid())
  item            Item          @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial      String
  user            User          @relation(fields: [userId], references: [id])
  userId          String
  status          RequestStatus @default(PENDING)
  calibrationDate DateTime
  validUntil      DateTime?
  
  // Informasi Sertifikat
  certificateNumber String?     // Format: [Nomor Urut]/CAL-PBI/[Bulan Romawi]/[Tahun]
  certificateUrl  String?       // URL ke file PDF sertifikat
  
  // Relasi
  statusLogs      CalibrationStatusLog[]
  vendor          Vendor?        @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Catatan tambahan
  notes           String?
  
  // Relasi ke sertifikat
  certificate     CalibrationCertificate?
  activityLogs    ActivityLog[]
}

// Model baru untuk detail sertifikat kalibrasi
model CalibrationCertificate {
  id                String     @id @default(uuid())
  calibration       Calibration @relation(fields: [calibrationId], references: [id], onDelete: Cascade)
  calibrationId     String     @unique // One-to-one relationship
  
  // Detail Vendor untuk Kalibrasi
  vendorAddress     String?    // Alamat vendor kalibrasi
  vendorPhone       String?    // Nomor telepon vendor
  vendorFax         String?    // Nomor fax vendor
  vendorName        String?    // Nama vendor untuk historis
  
  // Detail Alat
  manufacturer      String?    // Pembuat alat (contoh: RAE Systems)
  instrumentName    String?    // Nama instrumen (contoh: MeshGuard H2S)
  modelNumber       String?    // Model (contoh: FTD 2000 S)
  configuration     String?    // Konfigurasi (contoh: H2S)
  
  // Approval
  approvedBy        String?    // Nama yang menyetujui kalibrasi
  
  // Relations to multiple entries
  gasEntries        GasCalibrationEntry[]
  testEntries       TestResultEntry[]
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

// Model for gas calibration entries
model GasCalibrationEntry {
  id                String     @id @default(uuid())
  certificate       CalibrationCertificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  certificateId     String
  gasType           String    // Jenis gas (contoh: Hydrogen Sulphide (H2S))
  gasConcentration  String    // Konsentrasi gas (contoh: 25 ppm)
  gasBalance        String    // Balance gas (contoh: Nitrogen)
  gasBatchNumber    String    // Batch/Lot No (contoh: WO261451-1)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

// Model for test result entries
model TestResultEntry {
  id                String     @id @default(uuid())
  certificate       CalibrationCertificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  certificateId     String
  testSensor        String    // Sensor yang diuji (contoh: Hydrogen Sulphide (H2S))
  testSpan          String    // Span pengujian (contoh: 25 ppm)
  testResult        String    // Pass atau Fail
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

model Maintenance {
  id              String        @id @default(uuid())
  item            Item          @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial      String
  user            User          @relation(fields: [userId], references: [id])
  userId          String
  status          RequestStatus @default(PENDING)
  startDate       DateTime      @default(now())
  endDate         DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relasi ke form
  serviceReport   ServiceReport?
  technicalReport TechnicalReport?
  
  statusLogs      MaintenanceStatusLog[]
  activityLogs    ActivityLog[]
}

// Form 1: Customer Service Report
model ServiceReport {
  id                String      @id @default(uuid())
  maintenance       Maintenance @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  maintenanceId     String      @unique // One-to-one relationship
  
  reportNumber      String?     // No.: ___/CSR-PBI/___/2023
  customer          String?     // PT. Pertamina EP dsb
  location          String?
  brand             String?
  model             String?
  serialNumber      String?     // Item serial sebenarnya
  dateIn            DateTime?
  reasonForReturn   String?
  findings          String?
  action            String?
  
  // Service checklist
  sensorCO          Boolean     @default(false)
  sensorH2S         Boolean     @default(false)
  sensorO2          Boolean     @default(false)
  sensorLEL         Boolean     @default(false)
  lampClean         Boolean     @default(false)
  lampReplace       Boolean     @default(false)
  pumpTested        Boolean     @default(false)
  pumpRebuilt       Boolean     @default(false)
  pumpReplaced      Boolean     @default(false)
  pumpClean         Boolean     @default(false)
  instrumentCalibrate Boolean   @default(false)
  instrumentUpgrade  Boolean    @default(false)
  instrumentCharge   Boolean    @default(false)
  instrumentClean    Boolean    @default(false)
  instrumentSensorAssembly Boolean @default(false)
  
  // Parts List
  parts             ServiceReportPart[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Form 2: Technical Report
model TechnicalReport {
  id                String      @id @default(uuid())
  maintenance       Maintenance @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  maintenanceId     String      @unique // One-to-one relationship
  
  csrNumber         String?     // CSR NO: 090/CSR-PBI/IX/24
  deliveryTo        String?     // PT. Archroma Indonesia
  quoNumber         String?     // QUO No:
  dateReport        DateTime?   // Tanggal report (17 Sept 2024)
  techSupport       String?     // Nama technical support (Harry Sutiawan)
  dateIn            DateTime?   // Date In: 10 Sept 2024
  estimateWork      String?     // Estimate Work:
  reasonForReturn   String?     // Maintenance & calibration
  findings          String?     // QRAE 3 SN: M02A053250, Unit perlu kalibrasi ulang...
  action            String?     // Actions taken to fix the issue
  
  beforePhotoUrl    String?
  afterPhotoUrl     String?
  
  // Unit details
  partsList         TechnicalReportPart[]
  
  // Terms and conditions
  termsConditions   String?     // Opsional: jika terms berbeda antar laporan
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model ServiceReportPart {
  id                String       @id @default(uuid())
  serviceReport     ServiceReport @relation(fields: [serviceReportId], references: [id], onDelete: Cascade)
  serviceReportId   String
  itemNumber        Int          // Nomor urut item
  description       String       // Deskripsi part
  snPnOld           String?      // SN/PN/OLD pada form
  snPnNew           String?      // SN/PN/NEW pada form
  createdAt         DateTime     @default(now())
}

model TechnicalReportPart {
  id                String        @id @default(uuid())
  technicalReport   TechnicalReport @relation(fields: [technicalReportId], references: [id], onDelete: Cascade)
  technicalReportId String
  itemNumber        Int           // No
  namaUnit          String?       // Nama Unit (QRAE 3)
  description       String?       // Description (Kalibrasi)
  quantity          Int           @default(1) // QTY
  unitPrice         Float?        // Unit Price
  totalPrice        Float?        // Total Price
  createdAt         DateTime      @default(now())
}

// For usage tracking - rentals, calibrations, maintenance history
model ItemHistory {
  id         String      @id @default(uuid())
  item       Item        @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial String
  action     String      // RENTED, CALIBRATED, MAINTAINED
  details    String?     // Details about the usage
  relatedId  String?     // ID of related rental/calibration/maintenance record
  startDate  DateTime    @default(now())
  endDate    DateTime?
  createdAt  DateTime    @default(now())
}

// For movement and actions tracking
model ActivityLog {
  id               String       @id @default(uuid())
  type             ActivityType
  action           String       // Additional details about the action
  details          String?      // Description of the activity

  // Who performed the action
  user             User         @relation(fields: [userId], references: [id])
  userId           String

  // What was affected - only one of these will be set
  item             Item?        @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial       String?

  rental           Rental?      @relation(fields: [rentalId], references: [id])
  rentalId         String?

  calibration      Calibration? @relation(fields: [calibrationId], references: [id])
  calibrationId    String?

  maintenance      Maintenance? @relation(fields: [maintenanceId], references: [id])
  maintenanceId    String?

  affectedUser     User?        @relation("AffectedUserLogs", fields: [affectedUserId], references: [id])
  affectedUserId   String?

  vendor           Vendor?      @relation(fields: [vendorId], references: [id])
  vendorId         String?

  createdAt        DateTime     @default(now())
}

model Vendor {
  id           String        @id @default(uuid())
  name         String
  address      String?
  contactName  String?
  contactPhone String?
  contactEmail String?
  service      String?
  isDeleted    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  calibrations   Calibration[]
  vendorHistory  VendorHistory[]
  customerItems  Item[]       @relation("CustomerItems")
  activityLogs   ActivityLog[]
}

model VendorHistory {
  id           String      @id @default(uuid())
  vendor       Vendor      @relation(fields: [vendorId], references: [id])
  vendorId     String
  action       String      // CALIBRATION_COMPLETED, CONTRACT_RENEWED, etc.
  details      String?
  performance  Float?      // Rating for this specific interaction
  createdAt    DateTime    @default(now())
}

// Inventarisasi berkala
model InventoryCheck {
  id           String      @id @default(uuid())
  name         String?     // Nama jadwal inventory check
  scheduledDate DateTime
  completedDate DateTime?
  notes        String?
  createdBy    User        @relation(fields: [userId], references: [id])
  userId       String
  items        InventoryCheckItem[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  // Recurrence fields
  isRecurring  Boolean     @default(false)
  recurrenceType RecurrenceType? // MONTHLY or YEARLY
  nextDate     DateTime?   // Next occurrence date
}

// Add RecurrenceType enum
enum RecurrenceType {
  MONTHLY
  YEARLY
}

model InventoryCheckItem {
  id              String        @id @default(uuid())
  inventoryCheck  InventoryCheck @relation(fields: [checkId], references: [id])
  checkId         String
  item            Item          @relation(fields: [itemSerial], references: [serialNumber])
  itemSerial      String
  verifiedStatus  ItemStatus
  notes           String?
  createdAt       DateTime      @default(now())
}

// Status change logs
model CalibrationStatusLog {
  id            String        @id @default(uuid())
  calibration   Calibration   @relation(fields: [calibrationId], references: [id])
  calibrationId String
  status        RequestStatus
  notes         String?
  changedBy     User          @relation(fields: [userId], references: [id])
  userId        String
  createdAt     DateTime      @default(now())
}

model MaintenanceStatusLog {
  id              String        @id @default(uuid())
  maintenance     Maintenance   @relation(fields: [maintenanceId], references: [id])
  maintenanceId   String
  status          RequestStatus
  notes           String?
  changedBy       User          @relation(fields: [userId], references: [id])
  userId          String
  createdAt       DateTime      @default(now())
}

model RentalStatusLog {
  id            String        @id @default(uuid())
  rental        Rental        @relation(fields: [rentalId], references: [id])
  rentalId      String
  status        RequestStatus
  notes         String?
  changedBy     User          @relation(fields: [userId], references: [id])
  userId        String
  createdAt     DateTime      @default(now())
}

model Notification {
  id          String           @id @default(uuid())
  user        User             @relation(fields: [userId], references: [id])
  userId      String
  title       String
  message     String
  type        NotificationType
  isRead      Boolean          @default(false)
  relatedId   String?          // Reference to related entity (rental/calibration/etc)
  actionUrl   String?          // URL to navigate to when clicked
  actionLabel String?          // Label for the action button
  secondaryActionUrl String?   // URL for secondary action
  secondaryActionLabel String? // Label for secondary action
  createdAt   DateTime         @default(now())
}

// User notification preferences
model NotificationPreference {
  id                      String   @id @default(uuid())
  user                    User     @relation(fields: [userId], references: [id])
  userId                  String   @unique
  rentalNotifications     Boolean  @default(true)
  calibrationNotifications Boolean  @default(true)
  maintenanceNotifications Boolean  @default(true)
  inventoryNotifications  Boolean  @default(true)
  systemNotifications     Boolean  @default(true)
  emailNotifications      Boolean  @default(false)
  pushNotifications       Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Push notification subscription
model PushSubscription {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
=======
model Role {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  users       User[]

  @@map("roles")
}

model User {
  id           Int            @id @default(autoincrement())
  name         String
  email        String         @unique
  password     String
  roleId       Int            @map("role_id")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  role         Role           @relation(fields: [roleId], references: [id])
  requests     Request[]
  approvals    Request[]      @relation("ApprovedBy")
  activities   ActivityLog[]
  notifications Notification[]
  documents    Document[]     @relation("UploadedBy")
  itemHistory  ItemHistory[]  @relation("PerformedBy")

  @@map("users")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  items       Item[]

  @@map("categories")
}

model Status {
  id          Int         @id @default(autoincrement())
  type        String      // request, rental, calibration, item
  name        String      // pending, approved, etc
  items       Item[]
  requests    Request[]
  rentals     Rental[]
  calibrations Calibration[]

  @@map("statuses")
}

model Item {
  id            Int           @id @default(autoincrement())
  name          String
  categoryId    Int           @map("category_id")
  specification String?
  serialNumber  String?       @map("serial_number")
  statusId      Int           @map("status_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  category      Category      @relation(fields: [categoryId], references: [id])
  status        Status        @relation(fields: [statusId], references: [id])
  requests      Request[]
  itemHistory   ItemHistory[]

  @@map("items")
}

model Request {
  id            Int           @id @default(autoincrement())
  userId        Int           @map("user_id")
  itemId        Int           @map("item_id")
  requestType   String        @map("request_type") // rental / calibration
  reason        String?
  approvedBy    Int?          @map("approved_by")
  requestDate   DateTime      @map("request_date")
  statusId      Int           @map("status_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  user          User          @relation(fields: [userId], references: [id])
  item          Item          @relation(fields: [itemId], references: [id])
  approver      User?         @relation("ApprovedBy", fields: [approvedBy], references: [id])
  status        Status        @relation(fields: [statusId], references: [id])
  rental        Rental?
  calibration   Calibration?
  documents     Document[]
  itemHistory   ItemHistory[] @relation("RelatedRequest")

  @@map("requests")
}

model Rental {
  id               Int       @id @default(autoincrement())
  requestId        Int       @unique @map("request_id")
  startDate        DateTime  @map("start_date") 
  endDate          DateTime  @map("end_date")
  actualReturnDate DateTime? @map("actual_return_date")
  fineAmount       Decimal?  @map("fine_amount") @db.Decimal(10, 2)
  statusId         Int       @map("status_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  request          Request   @relation(fields: [requestId], references: [id])
  status           Status    @relation(fields: [statusId], references: [id])

  @@map("rentals")
}

model Calibration {
  id              Int       @id @default(autoincrement())
  requestId       Int       @unique @map("request_id")
  calibrationDate DateTime  @map("calibration_date")
  result          String?
  certificateUrl  String?   @map("certificate_url")
  statusId        Int       @map("status_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  request         Request   @relation(fields: [requestId], references: [id])
  status          Status    @relation(fields: [statusId], references: [id])

  @@map("calibrations")
}

model ItemHistory {
  id               Int      @id @default(autoincrement())
  itemId           Int      @map("item_id")
  activityType     String   @map("activity_type") // rental, calibration, maintenance
  relatedRequestId Int?     @map("related_request_id")
  description      String?
  performedBy      Int      @map("performed_by")
  date             DateTime
  item             Item     @relation(fields: [itemId], references: [id])
  relatedRequest   Request? @relation("RelatedRequest", fields: [relatedRequestId], references: [id])
  performer        User     @relation("PerformedBy", fields: [performedBy], references: [id])

  @@map("item_history")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  activity  String
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model DocumentType {
  id       Int        @id @default(autoincrement())
  name     String
  documents Document[]

  @@map("document_types")
}

model Document {
  id          Int          @id @default(autoincrement())
  requestId   Int          @map("request_id")
  fileName    String       @map("file_name")
  fileUrl     String       @map("file_url")
  uploadedBy  Int          @map("uploaded_by")
  typeId      Int          @map("type_id")
  uploadedAt  DateTime     @default(now()) @map("uploaded_at")
  request     Request      @relation(fields: [requestId], references: [id])
  uploader    User         @relation("UploadedBy", fields: [uploadedBy], references: [id])
  documentType DocumentType @relation(fields: [typeId], references: [id])

  @@map("documents")
>>>>>>> 0989372 (add fitur inventory dan history)
}